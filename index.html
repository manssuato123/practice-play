<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Practice Play</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0f1a">

<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#0b0f1a;color:#fff;margin:0;padding:20px}
  .wrap{max-width:980px;margin:auto}
  h1{margin:0 0 12px 0;font-size:22px}
  .card{background:#141827;border:1px solid #2a2f45;border-radius:12px;padding:14px;margin:12px 0}
  textarea{width:100%;min-height:180px;background:#0d1020;color:#fff;border:1px solid #2a2f45;border-radius:10px;padding:10px;font-size:14px;resize:vertical}
  button{border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;margin-right:8px}
  .gold{background:#d4af37;color:#111}
  .dark{background:#2c3350;color:#fff}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{background:#1b223a;border:1px solid #2a2f45;border-radius:999px;padding:6px 10px;font-size:13px}
  .big{font-size:20px;font-weight:900;margin-top:4px}
  .muted{color:#a9b2d6}
  .status{padding:10px;border-radius:10px;margin-top:10px;border:1px solid #2a2f45;background:#0d1020}
  input[type="range"]{width:220px}
  select{background:#0d1020;color:#fff;border:1px solid #2a2f45;border-radius:10px;padding:8px 10px}
  label{display:flex;align-items:center;gap:8px;cursor:pointer}
</style>
</head>

<body>
<div class="wrap">
  <h1>Practice Play (EN xN ‚Üí PT x1 ‚Üí Next)</h1>

  <div class="card">
    <div class="row">
      <div class="pill">Formato: <b>English | Portuguese</b> (1 por linha)</div>
      <div class="pill">Ex: <b>How are you? | Como voc√™ est√°?</b></div>
    </div>

    <textarea id="phrases"></textarea>

    <div class="row" style="margin-top:10px">
      <button class="gold" id="saveList">Salvar lista</button>
      <button class="dark" id="loadList">Carregar lista</button>
      <button class="dark" id="clearList">Limpar</button>
    </div>

    <div class="muted" style="margin-top:8px">
      Dica: no celular, ‚ÄúAdd to Home Screen‚Äù (GitHub Pages) para ficar offline.
    </div>
  </div>

  <div class="card">
    <div class="row">
      <button class="gold" id="playBtn">‚ñ∂ Play</button>
      <button class="dark" id="pauseBtn">‚è∏ Pause</button>
      <button class="dark" id="resumeBtn">‚ñ∂ Resume</button>
      <button class="dark" id="nextBtn">‚è≠ Next</button>
      <button class="dark" id="stopBtn">‚èπ Stop</button>
      <div class="pill">Frase: <span id="counter">0/0</span></div>
    </div>

    <div style="margin-top:12px">
      <div class="muted">Ingl√™s:</div>
      <div class="big" id="enText">‚Äî</div>

      <div class="muted" style="margin-top:10px">Portugu√™s:</div>
      <div class="status" id="ptText">‚Äî</div>

      <div class="status" id="status">Status: pronto.</div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="pill">Velocidade</div>
      <input id="rate" type="range" min="0.6" max="1.2" step="0.05" value="0.9"/>
      <div class="pill">rate: <span id="rateVal">0.9</span></div>

      <div class="pill">Repeti√ß√µes (EN)</div>
      <select id="reps">
        <option value="1">1x</option>
        <option value="2">2x</option>
        <option value="3" selected>3x</option>
        <option value="5">5x</option>
      </select>

      <label class="pill">
        <input id="pauseEach" type="checkbox">
        Pause after each phrase
      </label>
    </div>

    <div class="muted" style="margin-top:10px">
      Se ele ‚Äúmisturar l√≠nguas‚Äù, normalmente √© voz do sistema. Esse c√≥digo for√ßa a voz EN e PT quando dispon√≠vel.
    </div>
  </div>
</div>

<script>
/* =========================
   Keys (localStorage)
========================= */
const KEY_LIST = "practice_play_list_v1";
const KEY_CFG  = "practice_play_cfg_v1";

/* =========================
   Elements
========================= */
const phrasesTA = document.getElementById("phrases");
const saveList  = document.getElementById("saveList");
const loadList  = document.getElementById("loadList");
const clearList = document.getElementById("clearList");

const playBtn   = document.getElementById("playBtn");
const pauseBtn  = document.getElementById("pauseBtn");
const resumeBtn = document.getElementById("resumeBtn");
const nextBtn   = document.getElementById("nextBtn");
const stopBtn   = document.getElementById("stopBtn");

const enText    = document.getElementById("enText");
const ptText    = document.getElementById("ptText");
const counter   = document.getElementById("counter");
const statusBox = document.getElementById("status");

const rate      = document.getElementById("rate");
const rateVal   = document.getElementById("rateVal");
const repsSel   = document.getElementById("reps");
const pauseEach = document.getElementById("pauseEach");

/* =========================
   Default list + Load saved
========================= */
const defaultList =
`I think so. | Eu acho que sim.
I don‚Äôt think so. | Eu n√£o acho que sim.
It depends. | Depende.
That makes sense. | Isso faz sentido.
I‚Äôm not sure. | N√£o tenho certeza.`;

phrasesTA.value = localStorage.getItem(KEY_LIST) || defaultList;

/* =========================
   Save/Load/Clear list
========================= */
saveList.onclick = () => {
  localStorage.setItem(KEY_LIST, (phrasesTA.value || "").trim());
  alert("‚úÖ Lista salva!");
};
loadList.onclick = () => {
  phrasesTA.value = localStorage.getItem(KEY_LIST) || defaultList;
  alert("üì• Lista carregada!");
};
clearList.onclick = () => { phrasesTA.value = ""; };

/* =========================
   Config load/save
========================= */
function loadCfg(){
  try{
    const cfg = JSON.parse(localStorage.getItem(KEY_CFG) || "{}");
    if(typeof cfg.rate === "number") rate.value = String(cfg.rate);
    if(typeof cfg.reps === "string") repsSel.value = cfg.reps;
    if(typeof cfg.pauseEach === "boolean") pauseEach.checked = cfg.pauseEach;
  }catch(e){}
  rateVal.textContent = rate.value;
}
function saveCfg(){
  const cfg = {
    rate: parseFloat(rate.value),
    reps: repsSel.value,
    pauseEach: !!pauseEach.checked
  };
  localStorage.setItem(KEY_CFG, JSON.stringify(cfg));
}
rate.addEventListener("input", () => { rateVal.textContent = rate.value; saveCfg(); });
repsSel.addEventListener("change", saveCfg);
pauseEach.addEventListener("change", saveCfg);
loadCfg();

/* =========================
   Parse list
========================= */
function parseList(text){
  const lines = (text || "").split("\n").map(l => l.trim()).filter(Boolean);
  const items = [];
  for(const line of lines){
    const parts = line.split("|").map(p => p.trim());
    if(parts.length >= 2 && parts[0] && parts[1]){
      items.push({en: parts[0], pt: parts.slice(1).join(" | ")});
    }
  }
  return items;
}

/* =========================
   Voice selection (fix ‚Äúmix language‚Äù)
========================= */
let voices = [];
let voiceEN = null;
let voicePT = null;

function pickVoices(){
  voices = speechSynthesis.getVoices() || [];

  // Prefer en-GB, fallback en-*
  voiceEN = voices.find(v => /^en-GB/i.test(v.lang)) ||
            voices.find(v => /^en-/i.test(v.lang)) ||
            null;

  // Prefer pt-BR, fallback pt-PT, then pt-*
  voicePT = voices.find(v => /^pt-BR/i.test(v.lang)) ||
            voices.find(v => /^pt-PT/i.test(v.lang)) ||
            voices.find(v => /^pt-/i.test(v.lang)) ||
            null;
}

// Some browsers load voices async
speechSynthesis.onvoiceschanged = () => pickVoices();
pickVoices();

/* =========================
   Speech (promise-based)
========================= */
function speak(text, lang){
  return new Promise((resolve) => {
    if(!text) return resolve();

    const u = new SpeechSynthesisUtterance(text);
    u.rate = parseFloat(rate.value) || 0.9;
    u.lang = lang;

    // Force a matching voice when available
    if(lang.startsWith("en") && voiceEN) u.voice = voiceEN;
    if(lang.startsWith("pt") && voicePT) u.voice = voicePT;

    u.onend = resolve;
    u.onerror = resolve;

    // Do NOT cancel here (cancel would cut previous speech)
    speechSynthesis.speak(u);
  });
}

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

/* =========================
   Player state
========================= */
let list = [];
let idx = 0;
let running = false;
let paused = false;

function setStatus(t){ statusBox.textContent = "Status: " + t; }
function updateCounter(){ counter.textContent = `${Math.min(idx+1, list.length)}/${list.length}`; }

async function runLoop(){
  while(running){
    if(paused){
      await sleep(200);
      continue;
    }

    if(!list.length){
      setStatus("cole suas frases no formato English | Portuguese.");
      running = false;
      break;
    }

    if(idx >= list.length){
      enText.textContent = "‚úÖ Finalizado!";
      ptText.textContent = "‚Äî";
      setStatus("acabou a lista.");
      running = false;
      break;
    }

    const item = list[idx];
    updateCounter();
    enText.textContent = item.en;
    ptText.textContent = item.pt;

    // Clear queue before starting a phrase (prevents weird overlaps)
    speechSynthesis.cancel();
    await sleep(50);

    setStatus("falando ingl√™s...");
    const reps = parseInt(repsSel.value, 10) || 3;

    for(let r=0; r<reps; r++){
      if(!running) break;
      while(paused) await sleep(200);
      await speak(item.en, "en-GB");
      await sleep(180);
    }

    if(!running) break;
    while(paused) await sleep(200);

    setStatus("falando portugu√™s...");
    await speak(item.pt, "pt-BR");

    if(!running) break;

    // Pause after each phrase (optional)
    if(pauseEach.checked){
      paused = true;
      setStatus("pausado (Pause after each phrase). Clique Resume.");
      // do not increment until user resumes? -> increment now but wait
      idx++;
      continue;
    }

    idx++;
    setStatus("pr√≥xima...");
    await sleep(400);
  }
}

/* =========================
   Controls
========================= */
playBtn.onclick = () => {
  list = parseList(phrasesTA.value);
  idx = 0;
  running = true;
  paused = false;
  setStatus("iniciando...");
  runLoop();
};

stopBtn.onclick = () => {
  running = false;
  paused = false;
  speechSynthesis.cancel();
  setStatus("parado.");
};

pauseBtn.onclick = () => {
  paused = true;
  speechSynthesis.pause();
  setStatus("pausado. Clique Resume.");
};

resumeBtn.onclick = () => {
  paused = false;
  speechSynthesis.resume();
  setStatus("tocando...");
};

nextBtn.onclick = () => {
  // next works even when paused
  idx = Math.min(idx + 1, list.length);
  paused = false;
  speechSynthesis.cancel();
  setStatus("pulou para a pr√≥xima.");
};

</script>

<script>
  // PWA / Offline
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }
</script>
</body>
</html>
